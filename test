stages:
  - build
  - test
  - publish-pact
  - verify-pact
  - can-i-deploy
  - record-deployment
  - deploy

# ðŸ”¹ Publish Pacts (Consumer side)
publish-pact:
  stage: publish-pact
  image: pactfoundation/pact-cli:latest
  script:
    - echo "Publishing Pact contracts..."
    - pact-broker publish build/pacts \
        --consumer-app-version $CI_COMMIT_SHA \
        --branch $CI_COMMIT_REF_NAME \
        --broker-base-url=$PACT_BROKER_BASE_URL \
        --broker-token=$PACT_BROKER_TOKEN
  artifacts:
    paths:
      - build/pacts
  only:
    - merge_requests
    - main
    - develop

# ðŸ”¹ Verify Pacts (Provider side)
verify-pact:
  stage: verify-pact
  image: pactfoundation/pact-cli:latest
  script:
    - echo "Verifying Pacts..."
    - pact-broker can-i-deploy \
        --pacticipant $CI_PROJECT_NAME \
        --version $CI_COMMIT_SHA \
        --to-environment test \
        --broker-base-url=$PACT_BROKER_BASE_URL \
        --broker-token=$PACT_BROKER_TOKEN
  only:
    - main
    - develop

# ðŸ”¹ Check if service can be deployed
can-i-deploy:
  stage: can-i-deploy
  image: pactfoundation/pact-cli:latest
  script:
    - echo "Checking if we can deploy..."
    - pact-broker can-i-deploy \
        --pacticipant $CI_PROJECT_NAME \
        --version $CI_COMMIT_SHA \
        --to-environment staging \
        --broker-base-url=$PACT_BROKER_BASE_URL \
        --broker-token=$PACT_BROKER_TOKEN
  only:
    - main

# ðŸ”¹ Record Deployment (mark deployment in Pact Broker)
record-deployment:
  stage: record-deployment
  image: pactfoundation/pact-cli:latest
  script:
    - echo "Recording deployment in Pact Broker..."
    - pact-broker record-deployment \
        --pacticipant $CI_PROJECT_NAME \
        --version $CI_COMMIT_SHA \
        --environment production \
        --broker-base-url=$PACT_BROKER_BASE_URL \
        --broker-token=$PACT_BROKER_TOKEN
  only:
    - tags
